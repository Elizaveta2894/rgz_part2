{% extends "base.html" %}

{% block title %}–ü–æ–∏—Å–∫ —Ä–µ—Ü–µ–ø—Ç–æ–≤ - –ö—É–ª–∏–Ω–∞—Ä–Ω—ã–µ —Ä–µ—Ü–µ–ø—Ç—ã{% endblock %}

{% block content %}
<div class="hero">
    <h1>üîç –ü–æ–∏—Å–∫ —Ä–µ—Ü–µ–ø—Ç–æ–≤</h1>
    <p>–ù–∞–π–¥–∏—Ç–µ –∏–¥–µ–∞–ª—å–Ω—ã–π —Ä–µ—Ü–µ–ø—Ç –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞–º –∏–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</p>
</div>

<div class="search-container">
    <form id="searchForm" class="search-form">
        <div class="form-group">
            <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ—Ü–µ–ø—Ç–∞:</label>
            <input type="text" name="title" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ø–∞—Å—Ç–∞, —Å–∞–ª–∞—Ç, —Å—É–ø..." 
                   class="form-control" id="titleInput">
        </div>

        <div class="form-group">
            <label class="form-label">–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é):</label>
            <textarea name="ingredients" placeholder="—è–π—Ü–∞, –º—É–∫–∞, –º–æ–ª–æ–∫–æ..." 
                      class="form-control" id="ingredientsInput" rows="3"></textarea>
        </div>

        <div class="form-group">
            <label class="form-label">–†–µ–∂–∏–º –ø–æ–∏—Å–∫–∞ –ø–æ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞–º:</label>
            <div class="search-mode">
                <label>
                    <input type="radio" name="mode" value="any" checked>
                    <i class="fas fa-check-circle"></i> –•–æ—Ç—è –±—ã –æ–¥–∏–Ω –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç
                </label>
                <label>
                    <input type="radio" name="mode" value="all">
                    <i class="fas fa-list-check"></i> –í—Å–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã
                </label>
            </div>
        </div>

        <div class="search-filters">
            <div class="form-group">
                <label class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
                <select name="category" class="form-control" id="categorySelect">
                    <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                    {% for category in categories %}
                    <option value="{{ category }}">{{ category }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">–°–ª–æ–∂–Ω–æ—Å—Ç—å:</label>
                <select name="difficulty" class="form-control" id="difficultySelect">
                    <option value="">–õ—é–±–∞—è</option>
                    {% for difficulty in difficulties %}
                    <option value="{{ difficulty }}">{{ difficulty }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">–ú–∞–∫—Å. –≤—Ä–µ–º—è (–º–∏–Ω):</label>
                <input type="number" name="max_time" min="1" max="300" 
                       class="form-control" id="maxTimeInput" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 60">
            </div>
        </div>

        <div style="text-align: center; margin-top: 30px;">
            <button type="button" onclick="performSearch()" class="btn btn-primary">
                <i class="fas fa-search"></i> –ù–∞–π—Ç–∏ —Ä–µ—Ü–µ–ø—Ç—ã
            </button>
            <button type="reset" class="btn btn-secondary">
                <i class="fas fa-eraser"></i> –û—á–∏—Å—Ç–∏—Ç—å
            </button>
        </div>
    </form>
</div>

<div id="searchResults" class="search-results">
    <div class="search-results-header">
        <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞</h2>
        <span id="resultsCount" class="results-count">–ù–∞–π–¥–µ–Ω–æ: 0</span>
    </div>
    
    <div id="resultsContainer" class="recipes-grid">
    </div>
    
    <div id="noResults" style="display: none; text-align: center; padding: 40px;">
        <i class="fas fa-search" style="font-size: 60px; color: #ccc; margin-bottom: 20px;"></i>
        <h3>–†–µ—Ü–µ–ø—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
        <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞</p>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadPopularRecipes();
});

function loadPopularRecipes() {
    const params = {
        title: '',
        ingredients: [],
        mode: 'any',
        category: ''
    };
    
    callSearchApi(params);
}

function performSearch() {
    const form = document.getElementById('searchForm');
    const formData = new FormData(form);
    
    const ingredients = formData.get('ingredients');
    const ingredientsArray = ingredients ? 
        ingredients.split(',').map(i => i.trim()).filter(i => i) : [];
    
    const params = {
        title: formData.get('title') || '',
        ingredients: ingredientsArray,
        mode: formData.get('mode'),
        category: formData.get('category') || '',
        difficulty: formData.get('difficulty') || '',
        max_time: formData.get('max_time') ? parseInt(formData.get('max_time')) : null
    };
    
    callSearchApi(params);
}

async function callSearchApi(params) {
    try {
        const response = await fetch('/api', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                jsonrpc: '2.0',
                method: 'search_recipes',
                params: params,
                id: Date.now()
            })
        });
        
        const data = await response.json();
        displayResults(data.result?.recipes || []);
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', error);
        document.getElementById('resultsContainer').innerHTML = 
            '<div class="error">–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –ø–æ–∏—Å–∫–∞</div>';
    }
}

function displayResults(recipes) {
    const resultsContainer = document.getElementById('resultsContainer');
    const resultsCount = document.getElementById('resultsCount');
    const noResults = document.getElementById('noResults');
    
    resultsCount.textContent = `–ù–∞–π–¥–µ–Ω–æ: ${recipes.length}`;
    
    if (recipes.length === 0) {
        resultsContainer.innerHTML = '';
        noResults.style.display = 'block';
        return;
    }
    
    noResults.style.display = 'none';
    
    let html = '';
    recipes.forEach(recipe => {
        const ingredientsPreview = recipe.ingredients.slice(0, 3).join(', ') + 
                                 (recipe.ingredients.length > 3 ? '...' : '');
        
        html += `
        <div class="recipe-card">
            <img src="${recipe.image_url}" alt="${recipe.title}" class="recipe-image">
            <div class="recipe-content">
                <h3 class="recipe-title">
                    <a href="/recipe/${recipe.id}">${recipe.title}</a>
                </h3>
                <div class="recipe-meta">
                    <span class="recipe-category">${recipe.category}</span>
                    <span class="recipe-difficulty difficulty-${recipe.difficulty.toLowerCase()}">
                        ${recipe.difficulty}
                    </span>
                </div>
                <div class="recipe-ingredients-preview">
                    <strong>–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã:</strong> ${ingredientsPreview}
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                    <span><i class="far fa-clock"></i> ${recipe.cooking_time} –º–∏–Ω</span>
                    <span><i class="fas fa-user"></i> ${recipe.author}</span>
                    <a href="/recipe/${recipe.id}" class="recipe-link">
                        <i class="fas fa-arrow-right"></i> –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                    </a>
                </div>
            </div>
        </div>
        `;
    });
    
    resultsContainer.innerHTML = html;
}

let searchTimeout;
function onSearchInput() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(performSearch, 500);
}
</script>

<style>
.search-form {
    max-width: 800px;
    margin: 0 auto;
}

.search-results {
    margin-top: 50px;
}

.search-results-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 15px;
    border-bottom: 2px solid #4CAF50;
}

.results-count {
    background: #4CAF50;
    color: white;
    padding: 8px 16px;
    border-radius: 20px;
    font-weight: bold;
}

.error {
    background: #f8d7da;
    color: #721c24;
    padding: 20px;
    border-radius: 5px;
    text-align: center;
}
</style>
{% endblock %}